name: CI/CD Production Pipeline

on:
  push:
    branches: [ "main" ]  # Triggers whenever you push to main
  workflow_dispatch:      # Allows you to click a button to run manually

jobs:
  # ------------------------------------------------------------------
  # JOB 1: INTEGRATION (Test the code)
  # ------------------------------------------------------------------
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: ğŸ§ª Run Backend Tests
        # CHANGE 'ebank-backend' to your actual backend folder name if different
        working-directory: ./ebanking-backend 
        run: mvn test

  # ------------------------------------------------------------------
  # JOB 2: DEPLOYMENT (Update the VM)
  # ------------------------------------------------------------------
  deploy-to-azure:
    needs: test-backend  # Waits for tests to pass
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo "--------------------------------------------------"
            echo "ğŸ‰ Connecting to Azure VM..."
            
            # 1. Go to the project directory
            cd ${{ secrets.PROJECT_PATH }} || exit
            
            # 2. Get the latest code
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git pull origin main
            
            # 3. Clean up old containers/images (Your requested command)
            echo "ğŸ§¹ Cleaning up old resources..."
            sudo docker compose down --rmi local
            
            # 4. Rebuild and start everything
            echo "ğŸ—ï¸ Building and Starting services..."
            sudo docker compose up -d
            
            # 5. Fix Prometheus config reload
            echo "ğŸ”„ Restarting Prometheus..."
            sudo docker restart prometheus
            
            echo "--------------------------------------------------"
            echo "âœ… DEPLOYMENT SUCCESSFUL"